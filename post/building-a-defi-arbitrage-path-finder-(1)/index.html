<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
    <meta itemprop="name" content="Building a DeFi arbitrage path finder (1) | Solid Quant">
    <meta itemprop="description" content="How to find triangular arbitrage paths on Uniswap forked DEXs">

    
    <meta name="twitter:title" content="Building a DeFi arbitrage path finder (1) | Solid Quant">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="How to find triangular arbitrage paths on Uniswap forked DEXs">
    <meta name="twitter:site" content="@solidquant">
    <meta name="twitter:creator" content="@solidquant">
    <meta name="twitter:image:src" content="https://solidquant.github.io/blog/twitter.jpg">

    
    <meta name="og:title" content="Building a DeFi arbitrage path finder (1) | Solid Quant">
    <meta name="og:description" content="How to find triangular arbitrage paths on Uniswap forked DEXs">
    <meta name="og:image" content="https://solidquant.github.io/blog/og.jpg">
    <meta name="og:url" content="https://solidquant.github.io/blog/">
    <meta name="og:site_name" content="Solid Quant">
    <meta name="og:locale" content="en_GB">
    <meta name="og:type" content="website">

    <link rel="icon" type="image/x-icon" href="/blog/favicon.ico" />

    <title>Building a DeFi arbitrage path finder (1) | Solid Quant</title>

    <link rel="stylesheet" href="/blog/assets/main.bundle.css">

    
  </head>
  <body class="flex flex-col min-h-screen">
    <p class="top-notice">
    <a href="https://github.com/solidquant">Visit my Github</a>
</p>

    <header>
  <nav class="container mx-auto max-w-3xl px-8 pt-2 flex flex-wrap justify-between">
    <div>
      <h1>
        <a href="/blog/">Solid Quant</a>
      </h1>
      <p>A quant hobbyist&#39;s soul search</p>
    </div>

    <ul class="mt-6">
      <li>
        <a href="/blog/about">About</a>
      </li>
    </ul>
  </nav>
</header>
    <main class="container mx-auto max-w-3xl p-8 grow">
      
    <p></p>
    <div>
        <h2>Building a DeFi arbitrage path finder (1)</h2>

        
            <p class="excerpt">How to find triangular arbitrage paths on Uniswap forked DEXs</p>
        

        
            <div class="mb-2">
                <a class="tag MEV" href="/blog/tag/MEV">MEV</a><a class="tag arbitrage" href="/blog/tag/arbitrage">arbitrage</a>
            </div>
        

        
            
                <p class="text-sm italic">Created on
                    <span datetime="Fri Jun 16 2023 09:00:00 GMT+0900 (ÎåÄÌïúÎØºÍµ≠ ÌëúÏ§ÄÏãú)">June 16, 2023</span>.</p>
            
        

        <div class="content post">
            
                <hr />

                <h3>Table of Contents</h3>

                <nav class="toc">
                <ol>
                    
                    <li><a href="#starting-out">Starting out</a>
            		</li>

                    <li><a href="#arbitrage-opportunity-searching">Arbitrage opportunity searching</a>
            		</li>

                    <li><a href="#how-to-use-path-finder">How to use Path Finder</a>
            
                <ol>
                    
                    <li><a href="#1.-make_3_pairs">1. make_3_pairs</a>
            		</li>

                    <li><a href="#2.-make_paths_array">2. make_paths_array</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#what-to-do-next%3F">What to do next?</a>
            		</li>
                </ol>
            </nav>

                <hr />
            

            <p>¬†</p>
<h4 id="starting-out" tabindex="-1">Starting out</h4>
<p><img src="https://img.freepik.com/premium-vector/abstract-colour-wave-dots-black-background-3d-big-data-network-connection-technology-background_691453-136.jpg" alt="Flashbots"></p>
<p>I‚Äôve been working on my DEX arbitrage bot for about a week now.
As a result, I did manage to pull off my first few trades with a 5% success ratio - a very disappointing rate for most traders.
But I only needed to check if this strategy had any potential.
And if it did show any promise, I was going to give it the time it deserved and pursue it further.</p>
<p>The first bot I built was a proof of concept bot that simply used quotes to recognize price spreads across multiple pools on Arbitrum Uniswap V3, and placed multihop swap orders accordingly.</p>
<p>The execution layer wasn‚Äôt as difficult as it seemed at first, because there were numerous examples out there showing us exactly how we can send out order transactions onto the blockchain.</p>
<p>The below Github repos are among such examples:</p>
<ul>
<li><a href="https://github.com/mouseless-eth/rusty-sando">Rusty Sando</a></li>
<li><a href="https://github.com/paradigmxyz/artemis/tree/main/crates/strategies/opensea-sudo-arb">Artemis: Paradigmxyz‚Äôs Opensea/Sudoswap arbitrage bot</a></li>
<li><a href="https://github.com/BowTiedDevil/degenbot">Degenbot: Uniswap V2/V3 arbitrage bot</a></li>
<li><a href="https://github.com/libevm/subway">Subway: Uniswap V2 sandwich MEV bot written in TX</a></li>
</ul>
<p>The harder part was in understanding the atomicity of blockchain transactions, and why to ensure this I needed to use smart contracts to perform arbitrage strategies.</p>
<p>When I first grasped the concept of flashloans, it was eye opening, because there was no equivalent in legacy finance. But as revolutionizing as the tech is, I needed to learn to deploy smart contracts to ensure transaction atomicity. So I put this on hold for a while and moved on to another important aspect of arbitrage strategies - which I would like to talk about in this blog post today.</p>
<p>¬†</p>
<h4 id="arbitrage-opportunity-searching" tabindex="-1">Arbitrage opportunity searching</h4>
<p>The more difficult part of DEX arbitrage, for me, was in <strong>opportunity searching</strong>.</p>
<p>This, in my opinion, is the more important aspect of building profitable bots, but isn‚Äôt touched on that much.
Building an execution engine will take a couple of days tops to study and also to build - but if <strong>‚Äúsearching‚Äù</strong> isn‚Äôt done right, finding
profitable paths will take an infinite amount of time.</p>
<p>When you are attempting arbitrage trades on one DEX with a couple of liquidity abundant tokens like WETH, USDC, USDT, the 3-way pairs you can create are quite limited. So you can simply hardcode the 3-way paths and retrieve price quotes to update the profitability of each path.</p>
<p>The difficult part comes when you are attempting a 4-way, 5-way, n-way path swaps in multiple different DEXs. On top of this, try adding lending, derivatives, or options trading in DeFi to the equation, your path finding will become impossible to do by hand - or even with a program.</p>
<p>So, before I began developing my execution engine any further, I decided to build a simple system that finds n-way arbitrage paths using multiple DEXs. This was to:</p>
<ol>
<li>figure out if simple DEX arbitrage strategies were still profitable,</li>
<li>and if they weren‚Äôt anymore, under what conditions price spreads widened,</li>
<li>and to build a prototype simulation engine written in vectors to speed up my arbitrage path finding.</li>
</ol>
<p>This project is still a work in progress, but I did release my scripts on Github to keep track of my work. Here‚Äôs the link to the repo:</p>
<p><a href="https://github.com/solidquant/defi_path_finder">üëâ DeFi Path Finder Repo</a></p>
<p>¬†</p>
<h4 id="how-to-use-path-finder" tabindex="-1">How to use Path Finder</h4>
<p>The project structure is pretty simple as it retrieves data from Subgraphs and bulk loads information about Uniswap fork pools.</p>
<p>First, clone the Github repo:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/solidquant/defi_path_finder/tree/main</code></pre>
<p>Then, open up <em><a href="http://examples.py">examples.py</a></em>, where you will find the example code of using <strong>defi_path_finder</strong>.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> defi_path_finder <span class="token keyword">import</span> Preprocessor<br><span class="token keyword">from</span> defi_path_finder <span class="token keyword">import</span> make_triangular_paths<br><br><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span><br>    p <span class="token operator">=</span> Preprocessor<span class="token punctuation">(</span><span class="token punctuation">)</span><br>    pools<span class="token punctuation">,</span> reserves <span class="token operator">=</span> p<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><br>    pairs<span class="token punctuation">,</span> paths <span class="token operator">=</span> make_triangular_paths<span class="token punctuation">(</span>pools<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span></code></pre>
<p>The above code is everything that this project does.</p>
<p>You create a <strong>Preprocessor</strong> instance that collects subgraph data using the <strong>Collector</strong> instance. (<a href="https://github.com/solidquant/defi_path_finder/blob/main/defi_path_finder/preprocessor.py">preprocessor.py</a>)</p>
<p>The important function here is the <em>load_data(self, pool_cnt: int = 500)</em> method call:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pool_cnt<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token comment"># 1. Collect raw indexed data</span><br>    sushi <span class="token operator">=</span> self<span class="token punctuation">.</span>polygon_sushiswap_v2_pools<span class="token punctuation">(</span>pool_cnt<span class="token punctuation">)</span><br>    mesh <span class="token operator">=</span> self<span class="token punctuation">.</span>polygon_meshswap_v2_pools<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token comment"># 2. Create a numpy array by mapping token, exchange data to integers</span><br>    _arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><br><br>    <span class="token keyword">for</span> pools_df <span class="token keyword">in</span> <span class="token punctuation">[</span>sushi<span class="token punctuation">,</span> mesh<span class="token punctuation">]</span><span class="token punctuation">:</span><br>        pools <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pools_df<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span><br>        pools<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> pools_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'token0'</span><span class="token punctuation">,</span> <span class="token string">'token1'</span><span class="token punctuation">,</span> <span class="token string">'exchange'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<br>        _arr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pools<span class="token punctuation">)</span><br><br>    pools_array <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>_arr<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><br><br>    <span class="token comment"># 3. Create a numpy array containing reserves data for all existing pools</span><br>    reserves_array <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><br>        <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>TOKENS<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>TOKENS<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>EXCHANGES<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token number">2</span><br>    <span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">for</span> pools_df <span class="token keyword">in</span> <span class="token punctuation">[</span>sushi<span class="token punctuation">,</span> mesh<span class="token punctuation">]</span><span class="token punctuation">:</span><br>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> row <span class="token keyword">in</span> pools_df<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>            t0 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'token0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            t1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'token1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            e <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'exchange'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            r0 <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">'reserve0'</span><span class="token punctuation">]</span><br>            r1 <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">'reserve1'</span><span class="token punctuation">]</span><br><br>            reserves_array<span class="token punctuation">[</span>t0<span class="token punctuation">,</span> t1<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>r0<span class="token punctuation">,</span> r1<span class="token punctuation">]</span><br><br>    <span class="token keyword">return</span> pools_array<span class="token punctuation">,</span> reserves_array</code></pre>
<p>As seen from the code, it retrieves Sushiswap V2 pools data and Meshswap pools data.</p>
<p>It then creates a <strong>pools_array</strong> numpy array that looks like this:</p>
<pre class="language-bash"><code class="language-bash">array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">0</span>,   <span class="token number">1</span>,   <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span>  <span class="token number">2</span>,   <span class="token number">3</span>,   <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span>  <span class="token number">4</span>,   <span class="token number">1</span>,   <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">..</span>.,<br>       <span class="token punctuation">[</span>  <span class="token number">2</span>, <span class="token number">449</span>,   <span class="token number">1</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span> <span class="token number">10</span>, <span class="token number">450</span>,   <span class="token number">1</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">413</span>, <span class="token number">451</span>,   <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>This is a mappings of <strong>(token0, token1, exchange)</strong> from both the exchanges.</p>
<p>The first column represents: token0. The other two are: token1, exchange.</p>
<p>So basically, the first row of <strong>pools_array</strong> will be: pool where token0 is 0, token1 is 1, and the exchange is 0. This maps to: USDC-KLIMA pool in Sushiswap V2 at 0x5786b267d35f9d011c4750e0b0ba584e1fdbead1</p>
<p>Also, check a debug breakpoint somewhere within that function and try out the below commands:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> self.TOKENS<br><span class="token punctuation">{</span><span class="token string">'0x2791bca1f2de4661ed88a30c99a7a9449aa84174'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">'symbol'</span><span class="token builtin class-name">:</span> <span class="token string">'USDC'</span>, <span class="token string">'decimals'</span><span class="token builtin class-name">:</span> <span class="token string">'6'</span><span class="token punctuation">}</span>,<br><span class="token string">'0x4e78011ce80ee02d2c3e649fb657e45898257815'</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">'symbol'</span><span class="token builtin class-name">:</span> <span class="token string">'KLIMA'</span>, <span class="token string">'decimals'</span><span class="token builtin class-name">:</span> <span class="token string">'9'</span><span class="token punctuation">}</span>,<br><span class="token punctuation">..</span>. <span class="token punctuation">}</span><br><br><span class="token operator">>></span> self.EXCHANGES<br><span class="token punctuation">{</span><span class="token string">'sushiswap_v2'</span><span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">'meshswap'</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><br><br><span class="token operator">>></span> self.POOLS<span class="token punctuation">[</span><span class="token string">'0_1_0'</span><span class="token punctuation">]</span><br><span class="token string">'0x5786b267d35f9d011c4750e0b0ba584e1fdbead1'</span></code></pre>
<p>You can go check this out at: <a href="https://polygonscan.com/address/0x5786b267d35f9d011c4750e0b0ba584e1fdbead1#code">https://polygonscan.com/address/0x5786b267d35f9d011c4750e0b0ba584e1fdbead1#code</a></p>
<hr>
<p>¬†</p>
<p>Now that I have a mapper of all the pools in both the exchanges, what you want to do is call <strong>make_triangular_paths()</strong> function in <em><a href="http://utils.py">utils.py</a></em>. (<a href="https://github.com/solidquant/defi_path_finder/blob/main/defi_path_finder/utils.py">utils.py</a>)</p>
<p>This function will run in 2 steps.</p>
<ol>
<li><strong>make_3_pairs</strong>,</li>
<li><strong>make_paths_array</strong>.</li>
</ol>
<p>We will look at what each of these functions do.</p>
<h5 id="1.-make_3_pairs" tabindex="-1">1. make_3_pairs</h5>
<p>This function will create a combination of trangular pairs for all the tokens that you are tracking. This means that, for example, if you had tokens: <strong>WETH, WMATIC, WBTC, USDC, USDT</strong>, you should be able to make pairs that look like:</p>
<ul>
<li>WETH, WMATIC, WBTC</li>
<li>WETH, WMATIC, USDC</li>
<li>WETH, WMATIC, USDT</li>
<li>WMATIC, WBTC, USDC</li>
<li>WMATIC, WBTC, USDT</li>
<li>‚Ä¶</li>
</ul>
<p>so on and so forth.</p>
<p>This can be easily done with Python as below:</p>
<pre class="language-python"><code class="language-python">  tokens <span class="token operator">=</span> np<span class="token punctuation">.</span>unique<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># "data" is the "pools_array" from above</span><br>  combinations_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>combinations<span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>Try debuggin these values:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> tokens<br>array<span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token number">0</span>,   <span class="token number">1</span>,   <span class="token number">2</span>,   <span class="token number">3</span>,   <span class="token number">4</span>,   <span class="token number">5</span>,   <span class="token number">6</span>,   <span class="token number">7</span>,   <span class="token number">8</span>,   <span class="token number">9</span>,  <span class="token number">10</span>,  <span class="token number">11</span>,  <span class="token number">12</span>,<br>        <span class="token number">13</span>,  <span class="token number">14</span>,  <span class="token number">15</span>,  <span class="token number">16</span>,  <span class="token number">17</span>,  <span class="token number">18</span>,  <span class="token number">19</span>,  <span class="token number">20</span>,  <span class="token number">21</span>,  <span class="token number">22</span>,  <span class="token number">23</span>,  <span class="token number">24</span>,  <span class="token number">25</span>,<br>        <span class="token number">26</span>,  <span class="token number">27</span>,  <span class="token number">28</span>,  <span class="token number">29</span>,  <span class="token number">30</span>,  <span class="token number">31</span>,  <span class="token number">32</span>,  <span class="token number">33</span>,  <span class="token number">34</span>,  <span class="token number">35</span>,  <span class="token number">36</span>,  <span class="token number">37</span>,  <span class="token number">38</span>,<br>        <span class="token number">39</span>,  <span class="token number">40</span>,  <span class="token number">41</span>,  <span class="token number">42</span>,  <span class="token number">43</span>,  <span class="token number">44</span>,  <span class="token number">45</span>,  <span class="token number">46</span>,  <span class="token number">47</span>,  <span class="token number">48</span>,  <span class="token number">49</span>,  <span class="token number">50</span>,  <span class="token number">51</span>,<br>        <span class="token number">52</span>,  <span class="token number">53</span>,  <span class="token number">54</span>,  <span class="token number">55</span>,  <span class="token number">56</span>,  <span class="token number">57</span>,  <span class="token number">58</span>,  <span class="token number">59</span>,  <span class="token number">60</span>,  <span class="token number">61</span>,  <span class="token number">62</span>,  <span class="token number">63</span>,  <span class="token number">64</span>,<br>        <span class="token punctuation">..</span>. <span class="token punctuation">]</span><span class="token punctuation">)</span><br><br><span class="token operator">>></span> combinations_list<br><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">3</span><span class="token punctuation">)</span>, <span class="token punctuation">..</span>. <span class="token punctuation">]</span></code></pre>
<p><strong>combinations_list</strong> has all the possible 3-token combinations we can use to perform triangular arbitrage.</p>
<p>The next step is to run <strong>_make_3_pairs_process</strong> function to get <strong>pairs</strong> data that looks like the below:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> pairs.keys<span class="token punctuation">(</span><span class="token punctuation">)</span><br>dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">395</span>, <span class="token number">396</span>, <span class="token number">397</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">395</span>, <span class="token number">396</span>, <span class="token number">398</span><span class="token punctuation">)</span>, <span class="token punctuation">..</span>. <span class="token punctuation">]</span><span class="token punctuation">)</span><br><br><span class="token comment"># the array here has information on: token0, token1, exchange, token_in, token_out</span><br><span class="token operator">>></span> pairs<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">395</span>, <span class="token number">396</span>, <span class="token number">397</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">395</span>, <span class="token number">396</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">397</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">397</span>, <span class="token number">396</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">397</span>,   <span class="token number">1</span>, <span class="token number">395</span>, <span class="token number">397</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">396</span>, <span class="token number">395</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">397</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">396</span>, <span class="token number">397</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">397</span>,   <span class="token number">1</span>, <span class="token number">397</span>, <span class="token number">395</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br><br><span class="token operator">>></span> pairs<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><br>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">1</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">2</span>, <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">1</span>, <span class="token number">0</span>, <span class="token number">2</span>, <span class="token number">1</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">0</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">0</span>, <span class="token number">2</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">1</span>, <span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">2</span>, <span class="token number">0</span>, <span class="token number">1</span>, <span class="token number">0</span>, <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>Let‚Äôs take a look at <em>pairs[(0, 1, 2)]</em>. As you can see, you only need to look at the upper half of the array for unique pools information. The first 4 pools are:</p>
<ul>
<li>0, 1, 0</li>
<li>2, 0, 0</li>
<li>2, 1, 0</li>
<li>2, 0, 1</li>
</ul>
<p>pools from both exchanges 0 and 1. The latter two columns represent <strong>token_in, token_out</strong>. The additional columns are added to simplify the process of path building in the next step.</p>
<p>This function call will be run in parallel, because if you run it using one process, it will take an hour to finish. But using 6 processes will let you finish in 10 minutes. Also, the complexity of this process is directly related to how many combinations there are. So when you are doing 4-way, 5-way, n-way path findings, the time you have to input will grow exponentially.</p>
<p>The current method will work fine for triangular examples but will need improvements for other more complicated tasks.</p>
<h5 id="2.-make_paths_array" tabindex="-1">2. make_paths_array</h5>
<p>Now comes the most important part. Whereas the above function took a really long time to run, this process luckily takes a split second to finish.</p>
<p>Upon running:</p>
<pre class="language-python"><code class="language-python">paths <span class="token operator">=</span> make_paths_array<span class="token punctuation">(</span>pairs<span class="token punctuation">)</span></code></pre>
<p>You will get an output like this:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> paths<br>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">395</span>, <span class="token number">396</span><span class="token punctuation">]</span>,<br>        <span class="token punctuation">[</span><span class="token number">397</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">396</span>, <span class="token number">397</span><span class="token punctuation">]</span>,<br>        <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">397</span>,   <span class="token number">1</span>, <span class="token number">397</span>, <span class="token number">395</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,<br><br>       <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">397</span>,   <span class="token number">1</span>, <span class="token number">395</span>, <span class="token number">397</span><span class="token punctuation">]</span>,<br>        <span class="token punctuation">[</span><span class="token number">397</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">397</span>, <span class="token number">396</span><span class="token punctuation">]</span>,<br>        <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">396</span>, <span class="token number">395</span><span class="token punctuation">]</span><span class="token punctuation">]</span>,<br><br>        <span class="token punctuation">..</span>. <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>This is the 3-way path you are searching for. A close up would tell us more:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> paths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">395</span>, <span class="token number">396</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">397</span>, <span class="token number">396</span>,   <span class="token number">1</span>, <span class="token number">396</span>, <span class="token number">397</span><span class="token punctuation">]</span>,<br>       <span class="token punctuation">[</span><span class="token number">395</span>, <span class="token number">397</span>,   <span class="token number">1</span>, <span class="token number">397</span>, <span class="token number">395</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>Let‚Äôs look at the last 2 columns - which are <strong>token_in, token_out</strong>.</p>
<p>This swap path is as follows:</p>
<pre class="language-bash"><code class="language-bash">swap <span class="token number">395</span> to <span class="token number">396</span><br>       swap <span class="token number">396</span> to <span class="token number">397</span><br>              swap <span class="token number">397</span> to <span class="token number">395</span></code></pre>
<p>You can also get the pool address by:</p>
<pre class="language-bash"><code class="language-bash"><span class="token operator">>></span> p.POOLS<span class="token punctuation">[</span><span class="token string">'395_396_1'</span><span class="token punctuation">]</span><br><span class="token string">'0x2bab2b10e423491c12c449d99ad8aaed5c46fe4a'</span><br><br><span class="token operator">>></span> p.POOLS<span class="token punctuation">[</span><span class="token string">'397_396_1'</span><span class="token punctuation">]</span><br><span class="token string">'0x35456fd93f9e95fb059da27a18d6cc1266a1b3fb'</span><br><br><span class="token operator">>></span> p.POOLS<span class="token punctuation">[</span><span class="token string">'395_397_1'</span><span class="token punctuation">]</span><br><span class="token string">'0x3ee2a6db97f493f0221bb285f15e3021cdcaeccd'</span></code></pre>
<p>¬†</p>
<h4 id="what-to-do-next%3F" tabindex="-1">What to do next?</h4>
<p>Finding a 3-way path was straightforward. But the more difficult part is in:</p>
<ul>
<li>simulating the swap paths,</li>
<li>extending the framework to work on n-way paths</li>
</ul>
<p>In the next post, I would like to create a simple swap path simulation engine that accounts for market price impact.</p>

        </div>
            <p class="uppercase text-xs mt-6">Previous</p>

            <p class="font-bold">
                <a href="/blog/post/i-decided-to-build-my-own-mev-bot.-here&#39;s-how-i&#39;m-going-to-do-it./">I decided to build my own MEV bot. Here&#39;s how I&#39;m going to do it.</a>
            </p>
        
    </div>

    </main>
    <footer class="bg-gray-900 pb-10">
  <p class="block text-center text-sm mb-6"></p>
</footer>
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
    <script src="/blog/assets/main.bundle.js"></script>
  </body>
</html>
